<?xml version="1.0" encoding="UTF-8"?><!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Strict//EN" "http://www.w3.org/TR/xhtml1/DTD/xhtml1-strict.dtd"><html xmlns="http://www.w3.org/1999/xhtml" lang="pt"><head><meta http-equiv="Content-Type" content="text/html;charset=UTF-8"/><link rel="stylesheet" href="../jacoco-resources/report.css" type="text/css"/><link rel="shortcut icon" href="../jacoco-resources/report.gif" type="image/gif"/><title>PaymentRepositoryGateway.java</title><link rel="stylesheet" href="../jacoco-resources/prettify.css" type="text/css"/><script type="text/javascript" src="../jacoco-resources/prettify.js"></script></head><body onload="window['PR_TAB_WIDTH']=4;prettyPrint()"><div class="breadcrumb" id="breadcrumb"><span class="info"><a href="../jacoco-sessions.html" class="el_session">Sessions</a></span><a href="../index.html" class="el_report">Snack bar</a> &gt; <a href="index.source.html" class="el_package">com.snackbar.payment.infrastructure.gateways</a> &gt; <span class="el_source">PaymentRepositoryGateway.java</span></div><h1>PaymentRepositoryGateway.java</h1><pre class="source lang-java linenums">package com.snackbar.payment.infrastructure.gateways;

// This should be equivalent to the previous ServiceImpl

import com.snackbar.payment.application.gateways.PaymentGateway;
import com.snackbar.payment.domain.entity.Payment;
import com.snackbar.payment.domain.entity.PaymentMP;
import com.snackbar.payment.domain.entity.PaymentStatus;
import com.snackbar.payment.infrastructure.MpService;
import com.snackbar.payment.infrastructure.persistence.PaymentEntity;
import com.snackbar.payment.infrastructure.persistence.PaymentMPEntity;
import com.snackbar.payment.infrastructure.persistence.PaymentRepository;
import com.snackbar.payment.infrastructure.persistence.PaymentMPRepository;

import java.util.List;

/*Logging imports
import org.slf4j.Logger;
import org.slf4j.LoggerFactory;*/

public class PaymentRepositoryGateway implements PaymentGateway {

    //Logging definition
    //private static final Logger logger = LoggerFactory.getLogger(PaymentRepositoryGateway.class);

    private final PaymentRepository paymentRepository;
    private final PaymentMPRepository paymentMPRepository;
    private final PaymentEntityMapper paymentEntityMapper;
    private final PaymentMPEntityMapper paymentMPEntityMapper;
    private final MpService mpService;


    public PaymentRepositoryGateway(PaymentRepository paymentRepository,
                                    PaymentMPRepository paymentMPRepository,
                                    PaymentEntityMapper paymentEntityMapper,
                                    PaymentMPEntityMapper paymentMPEntityMapper,
<span class="nc" id="L37">                                    MpService mpService) {</span>
<span class="nc" id="L38">        this.paymentRepository = paymentRepository;</span>
<span class="nc" id="L39">        this.paymentMPRepository = paymentMPRepository;</span>
<span class="nc" id="L40">        this.paymentEntityMapper = paymentEntityMapper;</span>
<span class="nc" id="L41">        this.paymentMPEntityMapper = paymentMPEntityMapper;</span>
<span class="nc" id="L42">        this.mpService = mpService;</span>
<span class="nc" id="L43">    }</span>

    @Override
    public Payment createPayment(Payment paymentDomainObj) {
        //logger.info(&quot;Saving payment to database: {}&quot;, paymentDomainObj);
<span class="nc" id="L48">        PaymentEntity paymentEntity = paymentEntityMapper.toEntity(paymentDomainObj);</span>
<span class="nc" id="L49">        PaymentEntity savedObj = paymentRepository.save(paymentEntity);</span>
<span class="nc" id="L50">        Payment createdPayment = paymentEntityMapper.toDomainObj(savedObj);</span>
        //logger.info(&quot;Payment saved to database: {}&quot;, createdPayment);
<span class="nc" id="L52">        return createdPayment;</span>
    }

    @Override
    public List&lt;Payment&gt; listPayments() {
<span class="nc" id="L57">        List&lt;PaymentEntity&gt; retrievedObjList = paymentRepository.findAll();</span>
<span class="nc" id="L58">        List&lt;Payment&gt; retrievedPaymentsList = paymentEntityMapper.toDomainListObj(retrievedObjList);</span>
<span class="nc" id="L59">        return retrievedPaymentsList;</span>
        
    }

    @Override
    public PaymentMP createPaymentMP(PaymentMP paymentMPDomainObj) {
        //logger.info(&quot;Saving payment to database: {}&quot;, paymentDomainObj);
<span class="nc" id="L66">        PaymentMPEntity paymentMPEntity = paymentMPEntityMapper.toEntity(paymentMPDomainObj);</span>
<span class="nc" id="L67">        PaymentMPEntity savedObj = paymentMPRepository.save(paymentMPEntity);</span>
<span class="nc" id="L68">        PaymentMP createdPaymentMP = paymentMPEntityMapper.toDomainObj(savedObj);</span>
        //logger.info(&quot;Payment saved to database: {}&quot;, createdPayment);
<span class="nc" id="L70">        return createdPaymentMP;</span>
    }

    @Override
    public void webHookExecution(PaymentStatus paymentStatus) {
<span class="nc" id="L75">        this.mpService.patchBackMercadoPago(paymentStatus.callbackURL(), paymentStatus);</span>
<span class="nc" id="L76">    }</span>

    public Payment getPaymentById(String id) {
<span class="nc" id="L79">        PaymentEntity retrievedObj = paymentRepository.findById(id).orElse(null);</span>
<span class="nc" id="L80">        Payment retrievedPayment = paymentEntityMapper.toDomainObj(retrievedObj);</span>
<span class="nc" id="L81">        return retrievedPayment;</span>
    } 

    @Override
    public Payment updatePaymentExternalIdById(String id, String externalPaymentId) {
<span class="nc" id="L86">        PaymentEntity retrievedPayment = paymentRepository.findById(id).orElse(null);</span>
<span class="nc" id="L87">        retrievedPayment.setExternalPaymentId(externalPaymentId);</span>
<span class="nc" id="L88">        PaymentEntity savedObj = paymentRepository.save(retrievedPayment);</span>
<span class="nc" id="L89">        Payment updatedPayment = paymentEntityMapper.toDomainObj(savedObj);</span>
<span class="nc" id="L90">        return updatedPayment;</span>
    }

    @Override
    public Payment getPaymentByExternalId(String externalId) {
<span class="nc" id="L95">        PaymentEntity retrievedObj = paymentRepository.findByExternalPaymentId(externalId).orElse(null);</span>
<span class="nc" id="L96">        Payment retrievedPayment = paymentEntityMapper.toDomainObj(retrievedObj);</span>
<span class="nc" id="L97">        return retrievedPayment;</span>
    }

    @Override
    public Payment updatePaymentStatusByExternalId(String externalId, String paymentStatus) {
<span class="nc" id="L102">        PaymentEntity retrievedPayment = paymentRepository.findByExternalPaymentId(externalId).orElse(null);</span>
<span class="nc" id="L103">        retrievedPayment.setPaymentStatus(paymentStatus);</span>
<span class="nc" id="L104">        PaymentEntity savedObj = paymentRepository.save(retrievedPayment);</span>
<span class="nc" id="L105">        Payment updatedPayment = paymentEntityMapper.toDomainObj(savedObj);</span>
<span class="nc" id="L106">        return updatedPayment;</span>
    }

}
</pre><div class="footer"><span class="right">Created with <a href="http://www.jacoco.org/jacoco">JaCoCo</a> 0.8.10.202304240956</span></div></body></html>